<!DOCTYPE html>
<html>
<body>

<button id="start">Start</button>
<button id="stop">Stop</button>
<br>
<br>
<label for="timeInterval">Sound Clip Length (ms):</label>
<input id="timeInterval" type="number" value="3000">
<br>
<br>
<label for="chunkCount">Number of Chunks:</label>
<input id="chunkCount" type="number" value="50">
<br>
<br>
<label for="sequenceInput">Starting Sequence Number:</label>
<input id="sequenceInput" type="number" value="100">
<br>
<br>
<label for="flaskUrlInput">Flask Upload URL:</label>
<input id="flaskUrlInput" type="text" value="http://ec2-3-22-47-41.us-east-2.compute.amazonaws.com:8768/upload">
<br>
<br>
<button id="update">Update</button>

<script>

// Initialize config object
const config = {
  audioBuffer: [],
  mediaRecorder: null,
  intervalId: null,
  shouldContinueRecording: false,
  timeInterval: 3000,
  sequenceNumber: 100,
  chunkCount: 50,
  flaskUploadURL: "https://t3kgtlbatra1sb-8768.proxy.runpod.net/upload",
  shouldRestart: false,
  isMediaRecorderInitialized: false,
};

// Function to initialize MediaRecorder
const initializeMediaRecorder = () => {
  console.log("Initializing MediaRecorder");  // Debug log
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      config.mediaRecorder = new MediaRecorder(stream);
      config.isMediaRecorderInitialized = true;

      config.mediaRecorder.ondataavailable = e => {
        config.audioBuffer.push(e.data);
      };
      
      config.mediaRecorder.onstop = e => {
        console.log("MediaRecorder stopped");  // Debug log
        if (config.audioBuffer.length > 0) {
          const blob = new Blob(config.audioBuffer, { 'type' : 'audio/flac' });
          uploadToLinuxHost(blob);
          config.audioBuffer = [];
        }
        
        if (config.shouldContinueRecording) {
          config.mediaRecorder.start(config.timeInterval);
        }
      };
    })
    .catch(err => console.error('getUserMedia error', err));
};

// Function to generate file name
const generateFileName = () => {
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const sequence = String(config.sequenceNumber++).padStart(6, '0');
  return `${year}-${month}-${day}-${sequence}.flac`;
};

// Function to upload to LinuxHost
async function uploadToLinuxHost(blob) {
  const fileKey = generateFileName();
  console.log("Generated fileKey:", fileKey);
  const formData = new FormData();
  formData.append("file", blob, fileKey);

  await fetch(config.flaskUploadURL, {
    method: 'POST',
    body: formData,
  }).then(response => response.text())
    .then(data => console.log("Server Response:", data))
    .catch((error) => console.error("Error:", error));
}

// Function to update config
const updateConfig = () => {
  config.timeInterval = parseInt(document.getElementById('timeInterval').value);
  config.sequenceNumber = parseInt(document.getElementById('sequenceInput').value);
  config.chunkCount = parseInt(document.getElementById('chunkCount').value);
  config.flaskUploadURL = document.getElementById('flaskUrlInput').value;
};

document.getElementById('update').onclick = () => {
  updateConfig();
};

document.getElementById('start').onclick = () => {
  config.shouldContinueRecording = true;
  startRecording();
};

const startRecording = () => {
  console.log("Entering startRecording");  // Debug log
  console.log("MediaRecorder state:", config.mediaRecorder ? config.mediaRecorder.state : 'Not Initialized');  // Debug log
  console.log("shouldContinueRecording:", config.shouldContinueRecording);  // Debug log

  // Initialize MediaRecorder if not already initialized
  if (!config.isMediaRecorderInitialized) {
    console.log("Initializing MediaRecorder because it's not initialized");  // Debug log
    initializeMediaRecorder();
  }

  if (config.mediaRecorder && config.mediaRecorder.state !== 'recording') {
    console.log("Explicitly starting MediaRecorder");  // Debug log
    config.mediaRecorder.start(config.timeInterval);
  }
};

document.getElementById('stop').onclick = () => {
  config.shouldContinueRecording = false;
  if (config.mediaRecorder && config.mediaRecorder.state == 'recording') {
    config.mediaRecorder.stop();
  }
  if (config.intervalId) {
    clearInterval(config.intervalId);
  }
};

</script>

</body>
</html>

